<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <title>Productos — MercaPlan</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="static/css/productos.css">
</head>

<body>
    <nav class="navbar navbar-expand-lg bg-white border-bottom sticky-top">
        <div class="container">
            <a class="navbar-brand fw-bold" href="index.html">MercaPlan</a>
            <a class="btn btn-primary ms-auto" href="canasta.html">Mi Canasta</a>
        </div>
    </nav>

    <main class="container py-4">
        <div class="d-flex flex-wrap gap-2 mb-3">
            <input id="search" class="form-control" placeholder="Buscar…" style="min-width:260px">
            <select id="category" class="form-select" style="max-width:240px">
                <option value="">Todas las categorías</option>
            </select>
            <select id="order" class="form-select" style="max-width:240px">
                <option value="name">Orden: Nombre</option>
                <option value="brand">Orden: Marca</option>
            </select>
            <div class="ms-auto small text-muted">Snapshot: <span id="snapDate">—</span></div>
        </div>
        <div id="grid" class="row g-3"></div>
    </main>

    <script src="./static/js/app.js"></script>
    <script src="./static/js/basket.js"></script>
    <script>
        (async () => {
            const { products } = await loadBaseData();
            const q = new URL(location.href).searchParams.get('q') || '';
            document.getElementById('search').value = q;

            // poblar categorías
            const sel = document.getElementById('category');
            [...new Set(products.map(p => p.category))].sort().forEach(cat => {
                const opt = document.createElement('option'); opt.value = cat; opt.textContent = cat;
                sel.appendChild(opt);
            });

            const snap = await detectSnapshotDate();
            if (snap) document.getElementById('snapDate').textContent = snap;

            function render(list) {
                const grid = document.getElementById('grid');
                grid.innerHTML = '';
                if (!list.length) {
                    grid.innerHTML = `<div class="col-12"><div class="alert alert-warning">No se encontraron productos.</div></div>`;
                    return;
                }
                list.forEach(p => {
                    grid.insertAdjacentHTML('beforeend', `
      <div class="col-12 col-sm-6 col-lg-4">
        <div class="card h-100 shadow-sm">
          <img src="${p.image}" class="card-img-top object-fit-contain" style="height:180px" alt="${p.name}">
          <div class="card-body d-flex flex-column">
            <span class="badge text-bg-secondary align-self-start mb-2">${p.category}</span>
            <h6 class="card-title mb-1">${p.brand}</h6>
            <p class="small text-muted mb-3">${p.name}</p>
            <div class="mt-auto d-flex gap-2">
              <a href="comparador.html?id=${encodeURIComponent(p.id)}" class="btn btn-sm btn-outline-primary">Comparar</a>
              <button class="btn btn-sm btn-primary" onclick="addToBasket('${p.id}')">Agregar</button>
            </div>
          </div>
        </div>
      </div>`);
                });
            }

            function filter() {
                const term = document.getElementById('search').value.toLowerCase();
                const cat = document.getElementById('category').value;
                const order = document.getElementById('order').value;

                let out = products.filter(p => {
                    const hay = [p.name, p.brand, ...(p.synonyms || [])].join(' ').toLowerCase();
                    const matchesText = !term || hay.includes(term);
                    const matchesCat = !cat || p.category === cat;
                    return matchesText && matchesCat;
                });

                out = out.sort((a, b) => (a[order] || '').localeCompare(b[order] || ''));
                render(out);
            }

            document.getElementById('search').addEventListener('input', filter);
            document.getElementById('category').addEventListener('change', filter);
            document.getElementById('order').addEventListener('change', filter);

            filter(); // inicial
        })();
    </script>
</body>

</html>